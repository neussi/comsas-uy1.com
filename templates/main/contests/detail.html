{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<section class="py-5 bg-white">
    <div class="container">
        <!-- Header Concours -->
        <div class="row mb-5 justify-content-center">
            <div class="col-lg-10 text-center">
                {% if contest.image %}
                <img src="{{ contest.image.url }}" class="img-fluid rounded mb-4 shadow" alt="{{ contest.title }}"
                    style="max-height: 300px;">
                {% endif %}
                <h1 class="display-4 fw-bold">{{ contest.title }}</h1>
                <p class="lead text-muted">{{ contest.description }}</p>

                <div class="d-flex justify-content-center gap-3 mt-4">
                    <span class="badge bg-primary fs-6"><i class="bi bi-calendar-event me-2"></i> Fin: {{
                        contest.end_date|date:"d M Y H:i" }}</span>
                    <span class="badge bg-secondary fs-6"><i class="bi bi-people-fill me-2"></i> {{ candidates.count }}
                        Candidats</span>
                </div>
            </div>
        </div>

        {% if contest.is_open %}
        <!-- Vote Section -->
        <div class="row g-4 mb-5" id="candidates-grid">
            {% for candidate in candidates %}
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm text-center p-3 candidate-card">
                    <div class="mx-auto mb-3 position-relative" style="width: 150px; height: 150px;">
                        {% if candidate.photo %}
                        <img src="{{ candidate.photo.url }}" class="rounded-circle w-100 h-100 object-fit-cover shadow"
                            alt="{{ candidate.name }}">
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ candidate.name }}&background=random&size=150"
                            class="rounded-circle w-100 h-100 shadow" alt="{{ candidate.name }}">
                        {% endif %}
                        <div class="position-absolute bottom-0 end-0 bg-white rounded-circle p-1 shadow">
                            <span class="badge bg-primary rounded-pill vote-count-badge">{{ candidate.votes_count
                                }}</span>
                        </div>
                    </div>

                    <h5 class="fw-bold mb-1">{{ candidate.name }}</h5>
                    <p class="text-muted small mb-3">{{ candidate.bio|truncatewords:10 }}</p>

                    <button class="btn btn-outline-primary w-100 rounded-pill btn-vote"
                        data-candidate-id="{{ candidate.id }}" data-contest-slug="{{ contest.slug }}" {% if has_voted
                        %}disabled{% endif %}>
                        {% if has_voted %}
                        <i class="bi bi-check-circle me-1"></i> Voté
                        {% else %}
                        <i class="bi bi-hand-thumbs-up me-1"></i> Voter
                        {% endif %}
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning text-center">
            <h4><i class="bi bi-lock-fill me-2"></i> Les votes sont clos.</h4>
            <p>Merci de votre participation. Voici les résultats finaux.</p>
        </div>
        {% endif %}

        <!-- Results Chart -->
        <div class="row justify-content-center mt-5">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h4 class="card-title fw-bold mb-4 text-center">Résultats en temps réel</h4>
                        <canvas id="resultsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Vote Confirmation -->
<div class="modal fade" id="voteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer votre vote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Pour valider votre vote, veuillez entrer vos informations :</p>
                <form id="voteForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email étudiant</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="matricule" class="form-label">Matricule</label>
                        <input type="text" class="form-control" id="matricule" required>
                    </div>
                    <input type="hidden" id="candidateId">
                </form>
                <div id="voteError" class="alert alert-danger d-none mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmVoteBtn">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Chart Setup
        const ctx = document.getElementById('resultsChart').getContext('2d');
        const chartLabels = JSON.parse('{{ chart_labels|safe }}');
        const chartData = JSON.parse('{{ chart_data|safe }}');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Votes',
                    data: chartData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Voting Logic
        const voteModal = new bootstrap.Modal(document.getElementById('voteModal'));
        const voteBtn = document.querySelectorAll('.btn-vote');
        const confirmBtn = document.getElementById('confirmVoteBtn');

        voteBtn.forEach(btn => {
            btn.addEventListener('click', function () {
                if (this.disabled) return;
                document.getElementById('candidateId').value = this.dataset.candidateId;
                voteModal.show();
            });
        });

        confirmBtn.addEventListener('click', function () {
            const candidateId = document.getElementById('candidateId').value;
            const email = document.getElementById('email').value;
            const matricule = document.getElementById('matricule').value;
            const contestSlug = document.querySelector('.btn-vote[data-candidate-id="' + candidateId + '"]').dataset.contestSlug;

            if (!email || !matricule) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            fetch(`/concours/${contestSlug}/vote/${candidateId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email, matricule: matricule })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Vote enregistré avec succès !");
                        location.reload();
                    } else {
                        document.getElementById('voteError').textContent = data.error;
                        document.getElementById('voteError').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Une erreur est survenue.");
                });
        });
    });
</script>
{% endblock %}